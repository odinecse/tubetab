<!doctype html>
<html>
  <head>
    <title>Socket.IO chat <%= room %></title>
    <style>

    </style>
  </head>
  <body>
    <input id="videourl" type="text" autocomplete="off" /><button id="submitVideo">submitvideo</button>
    <input id="alias" type="text" autocomplete="off" /><button id="saveAlias">save</button>
    <ul id="previous"></ul>
    <div id="ytplayer"></div>
    <div id="skip">
      <button id="skipVideo">Skip (0)</button>
      (votes required to skip: 2)
    </div>
    <ul id="upcoming"></ul>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" type="text" autocomplete="off" /><button>Send</button>
    </form>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="/jquery.js"></script>
    <script src="/js.cookie.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var roomId = '<%= room %>';
      var ytplayer;
      var youtubeRX = /^.*(?:(?:youtu\.be\/|v\/|vi\/|u\/\w\/|embed\/)|(?:(?:watch)?\?v(?:i)?=|\&v(?:i)?=))([^#\&\?]*).*/;
      var COOKIE_NAME = 'tunetab_alias';
      var alias = Cookies.get(COOKIE_NAME) || false;
      var video = {};
      var tickInterval = {};
      var YT_API_RDY = false;

      function onYouTubeIframeAPIReady() {
        YT_API_RDY = true;
        console.log('onYouTubeIframeAPIReady', video);
        if(video.current) {
          ytplayer = new YT.Player('ytplayer', {
            height: '390',
            width: '640',
            videoId: video.current.videoId,
            playerVars: {
              autoplay: 1,
              controls: 0,
              disablekb: 1,
              enablejsapi: 1,
              fs: 0,
              modestbranding: 1,
              playsinline: 1,
              rel: 0,
              showinfo: 0
            },
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
            }
          });
        }
      }

      function onPlayerReady(event) {
        console.log('onPlayerReady');
        socket.emit('getVideoTime');
      }

      socket.on('officialVideoTime', function(data){
        console.log('officialVideoTime', data);
        ytplayer.seekTo(data.video.currentVideoTime);
      });

      function onPlayerStateChange(event) {
        // event.data =
        // -1 (unstarted)
        // 0 (ended)
        // 1 (playing)
        // 2 (paused)
        // 3 (buffering)
        // 5 (video cued).
        console.log('onPlayerStateChange', event.data);
        if(event.data === 1) {
          tickInterval = setInterval(function() {
            socket.emit('tick', {videoTime: ytplayer.getCurrentTime().toFixed(0)});
          }, 1111);
        } else {
          if(event.data === 0) {
            console.log(video.current.videoId, 'over!');
            socket.emit('playNextVideo', {videoId: video.current.videoId});
          }
          console.log('unset interval');
          window.clearInterval(tickInterval);
        }
      }

      function buildList(videos, reverse) {
        var out = '';
        if(typeof reverse !== 'undefined') {
          videos.reverse();
        }
        videos.forEach(function(video) {
          out += '<li><h4>' + video.videoTitle + '</h4>'
              + '<img height="' + video.videoThumb.height
              + '" width="' + video.videoThumb.height
              + '" src="' + video.videoThumb.url + '" />'
              + video.user + '</li>';
        });
        return out;
      }

      function renderPlaylist() {
        var previousList = '';
        var upcomingList = '';
        if(video.upcomingVideos.length > 0) {
          previousList = buildList(video.upcomingVideos, true);
        }
        if(video.previousVideos.length > 0) {
          upcomingList = buildList(video.previousVideos);
        }
        $('#previous').html(previousList);
        $('#upcoming').html(upcomingList);
      }

      socket.emit('login', {room: roomId, alias: alias});

      socket.on('welcome', function(data){
        Cookies.set(COOKIE_NAME, data.alias, { expires: 666});
        video = data.video;
        $('#alias').val(alias);
        console.log('welcome', data);
        if(YT_API_RDY) {
          onYouTubeIframeAPIReady();
          renderPlaylist();
        }
      });

      socket.on('message', function(data){
        console.log('message', data);
        $('#messages').append($('<li>').text(data.msg));
      });

      socket.on('announcement', function(data){
        console.log('announcement', data);
        $('#messages').append($('<li style="background-color:pink">').text(data.msg));
      });

      socket.on('firstVideo', function(data){
        console.log('firstVideo', data);
        video = data.video;
        if(YT_API_RDY) {
          onYouTubeIframeAPIReady();
        }
      });

      socket.on('playVideo', function(data){
        console.log('playVideo');
        video = data.video;
        if(video.current) {
          ytplayer.loadVideoById(video.current.videoId);
        } else {
          console.log('playlist done');
        }
        renderPlaylist();
      });

      socket.on('videoSubmitted', function(data){
        console.log('videoSubmitted', data);
        video = data.video;
        renderPlaylist();
      });

      // events
      $('#saveAlias').click(function() {
        var alias = $('#alias').val();
        Cookies.set(COOKIE_NAME, alias, { expires: 666});
        socket.emit('updateAlias', {alias: alias});
      });

      $('#submitVideo').click(function() {
        var video = $('#videourl').val();
        video = video.match(youtubeRX);
        if(video) {
          socket.emit('submitVideo', {video: video[1]});
        } else {
          console.log('error url');
        }
      });

      $('form').submit(function(){
        socket.emit('message', {msg: alias + ': ' + $('#m').val()});
        $('#m').val('');
        return false;
      });

    </script>
  </body>
</html>